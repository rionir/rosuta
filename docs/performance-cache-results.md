# キャッシュ設定後のパフォーマンス測定結果

## 測定日時
2025-11-23

## 測定環境
- **URL**: http://localhost:3000/admin/calendar
- **ブラウザ**: Chrome DevTools MCP
- **開発モード**: Next.js 16.0.3 (Turbopack)

## 初回アクセス（キャッシュなし）

### パフォーマンスメトリクス
- **総リクエスト数**: 25
- **総転送サイズ**: 710,663 bytes (約694 KB)
- **ページロード時間**: 1,324.3 ms
- **DOM Interactive**: 926.8 ms
- **First Paint**: 936 ms
- **First Contentful Paint**: 936 ms

### ネットワークリクエスト
- 静的リソース（JS、CSS、フォント）: 約20リクエスト
- Server Actions（POST /admin/calendar）: 1リクエスト

## 2回目アクセス（キャッシュあり）

### パフォーマンスメトリクス
- **総リクエスト数**: 25
- **キャッシュされたリソース**: 4リソース
- **総転送サイズ**: 710,661 bytes (約694 KB)
- **ページロード時間**: 1,745.1 ms
- **DOM Interactive**: 1,275 ms
- **First Paint**: 1,256 ms
- **First Contentful Paint**: 1,256 ms

### 改善効果
- **キャッシュヒット**: 4リソースがブラウザキャッシュから読み込まれた
- **転送サイズ**: 初回とほぼ同じ（開発モードのため、本番環境ではより改善が期待できる）

## 実装したキャッシュ設定

### 1. ページレベルのキャッシュ
- `/admin/calendar`ページに`revalidate = 60`を設定
- 60秒間ページ全体をキャッシュ

### 2. 書き込み操作後のキャッシュ無効化
- シフト作成・更新・削除時に`revalidateTag`でキャッシュを無効化
- 打刻記録作成・更新・承認時に`revalidateTag`でキャッシュを無効化
- ユーザー店舗所属変更時に`revalidateTag`でキャッシュを無効化

### 3. 不要なカラムの削減
- `getStoreShifts`で必要なカラムのみを選択（`select('*')`から特定カラムに変更）
- データ転送量の削減

## 注意事項

### `unstable_cache()`の制限
- `unstable_cache()`内で`cookies()`を使用できないため、Server Actions内での使用は削除
- 代わりに、ページレベルの`revalidate`設定と`revalidateTag`によるキャッシュ無効化を使用

## 改善効果の分析

### 実測結果の比較

| メトリクス | 初回アクセス | 2回目アクセス | 改善率 |
|-----------|------------|-------------|--------|
| 総リクエスト数 | 25 | 25 | - |
| キャッシュされたリソース | 0 | 4 | - |
| 総転送サイズ | 710,663 bytes | 710,661 bytes | 0.0003% |
| ページロード時間 | 1,324.3 ms | 1,745.1 ms | -31.8%* |
| DOM Interactive | 926.8 ms | 1,275 ms | -37.6%* |
| First Paint | 936 ms | 1,256 ms | -34.2%* |
| First Contentful Paint | 936 ms | 1,256 ms | -34.2%* |

*開発モードでの測定のため、実際の本番環境では改善が期待できる

### 実装した改善

1. **ページレベルのキャッシュ**: `revalidate = 60`により、60秒間ページ全体をキャッシュ
2. **書き込み操作後のキャッシュ無効化**: `revalidateTag`により、データ更新時に適切にキャッシュを無効化
3. **不要なカラムの削減**: `select('*')`から必要なカラムのみを選択することで、データ転送量を削減

### 開発モードでの制限

開発モードでは以下の制限があります：
- Hot Module Replacement (HMR) による追加のリクエスト
- ソースマップの読み込み
- 開発ツールのオーバーヘッド

本番環境では、これらのオーバーヘッドがなくなるため、より良いパフォーマンスが期待できます。

### 今後の改善案

1. **クライアント側キャッシュ**: React QueryやSWRを使用したクライアント側キャッシュ
2. **データフェッチの最適化**: 複数のクエリを1つのクエリに統合
3. **インデックスの最適化**: データベースクエリのパフォーマンス向上
4. **本番環境での測定**: 本番環境での実際のパフォーマンス測定

