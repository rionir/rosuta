---
alwaysApply: true
---

# Supabase ベストプラクティス

### 1. 認証（Authentication）
- **クライアントサイド認証**: `@supabase/supabase-js`のクライアントライブラリを使用
- **サーバーサイド認証**: Server ComponentsやServer ActionsでSupabaseクライアントを適切に初期化
- **セッション管理**: セッショントークンは安全に管理し、適切な有効期限を設定
- **認証状態の確認**: `getUser()`や`getSession()`を使用して認証状態を確認
- **認証ミドルウェア**: 保護されたルートでは認証チェックを実装

### 2. Row Level Security (RLS)
- **RLSポリシーの設定**: すべてのテーブルにRLSを有効化し、適切なポリシーを設定
- **ユーザー固有データの保護**: `auth.uid()`を使用してユーザーごとのデータアクセスを制御
- **ポリシーのテスト**: 開発環境でRLSポリシーを十分にテスト
- **パフォーマンス**: RLSポリシーは効率的に記述し、不要なスキャンを避ける

### 3. データベース設計
- **正規化**: 適切な正規化を行い、データの整合性を保つ
- **インデックスの設定**: 頻繁にクエリされるカラムにインデックスを設定
- **外部キー制約**: リレーションシップには外部キー制約を設定
- **型安全性**: TypeScriptの型定義を生成し、型安全性を確保（`supabase gen types`）

### 4. データフェッチング
- **Server Componentsでの使用**: Server Components内でSupabaseクライアントを使用してデータフェッチング
- **リアルタイムサブスクリプション**: 必要な場合のみリアルタイム機能を使用（Client Components）
- **クエリの最適化**: 必要なカラムのみを選択し、JOINを適切に使用
- **ページネーション**: 大量のデータにはページネーションを実装

### 5. セキュリティ
- **環境変数の管理**: SupabaseのURLとanon keyは環境変数で管理
- **サービスロールキー**: サービスロールキーはサーバーサイドでのみ使用（絶対にクライアントに露出しない）
- **APIキーの保護**: クライアントサイドではanon keyのみを使用
- **SQLインジェクション対策**: パラメータ化クエリを使用（Supabaseクライアントは自動的に処理）

### 6. エラーハンドリング
- **エラーの適切な処理**: Supabaseのエラーオブジェクトを適切に処理
- **ユーザーフレンドリーなメッセージ**: エラーメッセージをユーザーに分かりやすく表示
- **ログ記録**: サーバーサイドでエラーを適切にログ記録

### 7. パフォーマンス
- **接続プーリング**: Supabaseの接続プーリングを活用
- **キャッシング**: 頻繁にアクセスされるデータは適切にキャッシュ
- **バッチ処理**: 複数の操作は可能な限りバッチで処理
