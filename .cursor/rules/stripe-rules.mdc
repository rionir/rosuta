---
alwaysApply: true
---

# Stripe ベストプラクティス

### 1. APIキーとセキュリティ
- **環境変数の管理**: StripeのAPIキーは環境変数で管理（`.env.local`）
- **公開可能キーとシークレットキー**: 
  - 公開可能キー（`NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`）: クライアントサイドで使用
  - シークレットキー（`STRIPE_SECRET_KEY`）: サーバーサイドでのみ使用（絶対にクライアントに露出しない）
- **テストモードと本番モード**: 開発環境ではテストキー、本番環境では本番キーを使用
- **APIバージョンの固定**: Stripe APIのバージョンを固定し、意図しない変更を防ぐ

### 2. 決済フロー
- **Checkout Session**: Stripe Checkoutを使用して決済フローを簡素化
- **Payment Intent**: カスタム決済フローが必要な場合はPayment Intentを使用
- **決済体験の最適化**: 決済プロセスを簡潔にし、不要なステップを削減
- **モバイル対応**: モバイルデバイスでの決済体験を最適化

### 3. サブスクリプション管理
- **サブスクリプションの作成**: `stripe.subscriptions.create()`を使用
- **サブスクリプションの更新**: プラン変更やキャンセル処理を適切に実装
- **Webhookでの同期**: サブスクリプションの状態変更はWebhookで処理
- **顧客ポータル**: Stripe Customer Portalを活用して顧客が自己管理できるようにする

### 4. Webhook処理
- **Webhookエンドポイント**: Server ActionsまたはAPI RoutesでWebhookエンドポイントを実装
- **イベントの検証**: `stripe.webhooks.constructEvent()`でWebhookイベントの署名を検証
- **べき等性の確保**: Webhookハンドラーはべき等性を確保（同じイベントを複数回処理しても問題ないように）
- **エラーハンドリング**: Webhook処理のエラーを適切に処理し、リトライロジックを実装
- **イベントタイプの処理**: 必要なイベントタイプ（`checkout.session.completed`、`customer.subscription.updated`など）を適切に処理

### 5. データベースとの同期
- **Supabaseとの連携**: Stripeの顧客IDやサブスクリプションIDをSupabaseに保存
- **状態の同期**: Stripeのサブスクリプション状態とSupabaseのユーザー状態を同期
- **トランザクション**: データベース更新はトランザクションで処理

### 6. 不正行為の防止
- **Stripe Radar**: Stripe Radarを活用して不正取引を検出・防止
- **3D Secure**: 3D Secure認証を有効化
- **不正検知ルール**: 適切な不正検知ルールを設定

### 7. エラーハンドリング
- **Stripeエラーの処理**: Stripeのエラーオブジェクトを適切に処理
- **カードエラー**: カードエラーをユーザーに分かりやすく表示
- **リトライロジック**: 一時的なエラーにはリトライロジックを実装

### 8. テスト
- **テストモード**: 開発環境ではStripeのテストモードを使用
- **テストカード**: Stripeのテストカードを使用して決済フローをテスト
- **Webhookのテスト**: Stripe CLIを使用してWebhookをローカルでテスト

### 9. 収益認識
- **発生主義会計**: Stripeの収益認識機能を使用して発生主義会計を実現
- **請求書の管理**: 適切な請求書管理を実装

### 10. ユーザー体験
- **ローディング状態**: 決済処理中は適切なローディング状態を表示
- **成功/失敗ページ**: 決済完了後のリダイレクト先を適切に設定
- **メール通知**: Stripeのメール通知機能を活用
